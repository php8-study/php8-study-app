<div class="max-w-xl mx-auto py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">
    模擬試験
  </h1>
  
  <div class="bg-white p-6 shadow-lg rounded-xl mb-6">
    <h2 class="text-lg font-semibold text-indigo-700 mb-4">
      問題 <%= @exam_question.position %> / <%= @exam.exam_questions.count %>
    </h2>

    <p class="text-xl text-gray-800 whitespace-pre-wrap mb-6"><%= @question.content %></p>

    <%= form_with url: answer_exam_exam_question_path(@exam, @exam_question), method: :post, local: true, class: "space-y-4" do %>

      <% selected_choice_ids = @exam_answers.pluck(:question_choice_id) if @exam_answers.present? %>

      <div class="space-y-3">
        <% @question.question_choices.each do |choice| %>
          <% is_selected = selected_choice_ids.present? && selected_choice_ids.include?(choice.id) %>

          <label class="flex items-start p-3 rounded-lg border border-gray-200 cursor-pointer transition-colors 
            <%= is_selected ? 'bg-indigo-100 border-indigo-400' : 'bg-gray-50 hover:bg-indigo-50' %>"
            data-choice-id="<%= choice.id %>"
          >

            <%= check_box_tag 'question_choice_ids[]', choice.id, is_selected, 
              class: "w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mt-0.5 mr-3" %>

            <span class="text-lg text-gray-700"><%= choice.content %></span>
          </label>
        <% end %>
      </div>

      <div class="pt-4">
        <button type="submit" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
          <%= @exam_answers.present? ? "回答を更新する" : "回答を送信" %>
        </button>
      </div>
    <% end %>
  </div>

  <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">

    <% prev_q = @exam_question.previous_question %>
    <% if prev_q %>
      <%= link_to "前の問題へ", exam_exam_question_path(@exam, prev_q),
                  class: "px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg font-semibold hover:bg-indigo-100 transition-colors" %>
    <% else %>
      <span class="px-4 py-3 bg-gray-100 text-gray-400 rounded-lg font-semibold cursor-not-allowed">前の問題へ</span>
    <% end %>

    <%= link_to "確認ページへ", review_exam_path(@exam),
                class: "px-4 py-3 text-gray-600 border border-gray-400 rounded-lg font-semibold hover:bg-gray-100 transition-colors" %>

    <% next_q = @exam_question.next_question %>
    <% if next_q %>
      <%= link_to "次の問題へ", exam_exam_question_path(@exam, next_q),
                  class: "px-4 py-3 bg-indigo-100 text-indigo-700 rounded-lg font-semibold hover:bg-indigo-200 transition-colors" %>
    <% else %>
      <%= link_to "最終確認へ", review_exam_path(@exam),
                  class: "px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors" %>
    <% end %>
  </div>
</div>
